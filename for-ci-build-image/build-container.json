{
  "variables": {
    "dockerhub_user": null,
    "dockerhub_pw": null
  },

  "builders": [
    {
      "commit": "true",
      "image": "maven:3.6.3-amazoncorretto-11",
      "type": "docker"
    }
  ],

  "post-processors": [
    [
      {
        "repository": "zepben/pipeline-java",
        "tags": [ "latest" ],
        "type": "docker-tag"
      },
      {
        "type": "docker-push",
        "login": true,
        "login_username": "{{user `dockerhub_user`}}",
        "login_password": "{{user `dockerhub_pw`}}"
      }
    ]
  ],

  "provisioners": [
    {
      "destination": "/root/deps-pom.xml",
      "source": "../deps-pom.xml",
      "type": "file"
    },
    {
      "destination": "/root/pom.xml",
      "source": "../pom.xml",
      "type": "file"
    },
    {
      "destination": "/root/src/",
      "source": "src/",
      "type": "file"
    },
    {
      "inline": [
        "yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm",
        "yum install -y git awscli gnupg jq xmlstarlet",
        "cd /root",
        "mvn install -f pom.xml",
        "mvn dependency:go-offline -f deps-pom.xml",
        "mkdir -p src/main/java",
        "mvn clean verify -f deps-pom.xml",
        "rm -rf target",
        "rm -rf src",
        "rm -f *.xml",
        "mv -f .m2/repository local_repo",
        "mkdir /maven",
        "rm -rf /etc/localtime",
        "ln -s /usr/share/zoneinfo/Australia/Sydney /etc/localtime"
      ],
      "type": "shell"
    },
    {
      "destination": "/root/.m2/settings.xml",
      "source": "maven-settings.xml",
      "type": "file"
    },
    {
      "destination": "/root/.aws/",
      "source": "./aws/",
      "type": "file"
    }
  ]
}

